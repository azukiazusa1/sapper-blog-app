name: CI-App
on:
  pull_request:
    paths:
      - app/**
      - package.lock.json

env:
  API_KEY: ${{ secrets.PREVIEW_API_KEY }}
  PREVIEW_API_KEY: ${{ secrets.PREVIEW_API_KEY }}
  SPACE: ${{ secrets.PREVIEW_SPACE }}
  ENVIRONMENTS: test
  PUBLIC_BASE_URL: http://localhost:3000
  PUBLIC_ANALYTICS_ID: ""
  GITHUB_TOKEN: ""
  PRIVATE_KEY: ""
  CLIENT_EMAIL: ""
  PROPERTY_ID: ""
  CF_ENV: development
  # Turborepo Remote Cache
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: ${{ secrets.TURBO_TEAM }}

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: package.json
          cache: npm
      - name: Build
        uses: preactjs/compressed-size-action@v2
        with:
          pattern: "app/.svelte-kit/cloudflare/**/*.{js,css,html.json}"

  lighthouse:
    name: Lighthouse
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      - name: Set up
        uses: ./.github/workflows/wf-setup.yaml
      - name: Install Lighthouse CI
        run: npm install -g @lhci/cli@0.10.x
      - name: Build
        run: npm run build
      - name: Run Lighthouse CI
        run: lhci autorun
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
  a11y:
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/playwright:v1.44.1-focal
    steps:
      - uses: actions/checkout@v4
      - name: Set up
        uses: ./.github/workflows/wf-setup.yaml
      - name: Build
        run: npm run build
      - name: Add permissions
        run: chmod 777 -R .
      - name: Run a11y test
        run: npx playwright test
        working-directory: app
      - uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: test-results
          path: app/artifacts/
