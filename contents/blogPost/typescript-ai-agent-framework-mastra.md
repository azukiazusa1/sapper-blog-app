---
id: aX-wmweLDeNGqxyniMUN1
title: "TypeScript è£½ã® AI ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ Mastra"
slug: "typescript-ai-agent-framework-mastra"
about: "Mastra ã¯ TypeScript è£½ã® AI ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã‚ã‚Š Gatsby ã®é–‹ç™ºãƒãƒ¼ãƒ ã«ã‚ˆã£ã¦é–‹ç™ºã•ã‚Œã¦ã„ã¾ã™ã€‚Mastra ã‚µãƒ¼ãƒãƒ¼ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ REST API ã‚µãƒ¼ãƒãƒ¼ã‚’ä»‹ã—ã¦ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨ã‚„ã‚Šå–ã‚Šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚Mastra ã¯AI ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’æ§‹ç¯‰ã™ã‚‹ãŸã‚ã«å¿…è¦ãªãƒ—ãƒªãƒŸãƒ†ã‚£ãƒ–ãªæ©Ÿèƒ½ã‚’æä¾›ã™ã‚‹ãŸã‚ã«è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ã€‚"
createdAt: "2025-03-09T10:16+09:00"
updatedAt: "2025-03-09T10:16+09:00"
tags: ["AI", "Mastra", "OpenTelemetry", ""]
thumbnail:
  url: "https://images.ctfassets.net/in6v9lxmm5c8/5m9GakLihc997ujoamvxZ3/7341ffcb10a2b431fe089f5da95f718e/chocolate-mousse-cake_17001-768x768.png"
  title: "ãƒãƒ§ã‚³ãƒ¬ãƒ¼ãƒˆãƒ ãƒ¼ã‚¹ã®ã‚¤ãƒ©ã‚¹ãƒˆ"
selfAssessment:
  quizzes:
    - question: "Mastra ã§ãƒ„ãƒ¼ãƒ«ã‚’ä½œæˆã™ã‚‹æ–¹æ³•ã¨ã—ã¦æ­£ã—ã„ã‚‚ã®ã¯ã©ã‚Œã‹ï¼Ÿ"
      answers:
        - text: "const weatherTool = new Tool({ ... })"
          correct: false
          explanation: null
        - text: "const weatherTool = createTool({ ... })"
          correct: true
          explanation: null
        - text: "function weatherTool(): Tool { ... }"
          correct: false
          explanation: null
        - text: "const weatherTool = buildTool({ ... })"
          correct: false
          explanation: null
published: true
---
Mastra ã¯ TypeScript è£½ã® AI ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã‚ã‚Š [Gatsby](https://www.gatsbyjs.com/) ã®é–‹ç™ºãƒãƒ¼ãƒ ã«ã‚ˆã£ã¦é–‹ç™ºã•ã‚Œã¦ã„ã¾ã™ã€‚Mastra ã‚µãƒ¼ãƒãƒ¼ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ REST API ã‚µãƒ¼ãƒãƒ¼ã‚’ä»‹ã—ã¦ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨ã‚„ã‚Šå–ã‚Šã§ãã¾ã™ã€‚Mastra ã¯ AI ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’æ§‹ç¯‰ã™ã‚‹ãŸã‚ã«å¿…è¦ãªãƒ—ãƒªãƒŸãƒ†ã‚£ãƒ–ãªæ©Ÿèƒ½ã‚’æä¾›ã™ã‚‹ãŸã‚ã«è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ã€‚

https://mastra.ai/

Mastra ã‚’ä½¿ç”¨ã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªæ©Ÿèƒ½ã‚’å®Ÿè£…ã§ãã¾ã™ã€‚

- **ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ**: è¤‡é›‘ãªã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã® AI ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å®šç¾©ã™ã‚‹
  - æ§˜ã€…ãª AI ãƒ—ãƒ­ãƒã‚¤ãƒ€ã‚’è‡ªç”±ã«åˆ‡ã‚Šæ›¿ãˆã¦ä½¿ç”¨ã§ãã‚‹
  - ãƒ¡ãƒ¢ãƒªã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§éå»ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ä¿æŒã—ã¦å›ç­”ã‚’ç”Ÿæˆã§ãã‚‹
  - ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦å¤–éƒ¨ã®æƒ…å ±ã‚’å–å¾—ã—ã€å›ç­”ã®ç²¾åº¦ã‚’å‘ä¸Šã•ã›ã‚‹ã“ã¨ãŒã§ãã‚‹
- **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼**: ã‚°ãƒ©ãƒ•ãƒ™ãƒ¼ã‚¹ã®ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ã‚’æ§‹ç¯‰ã—ã¦è¤‡é›‘ãª LLM æ“ä½œã‚’å®Ÿè¡Œã™ã‚‹
- **RAGï¼ˆRetrieval Augmented Generationï¼‰**: ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«å¤§é‡ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’èª­ã¿è¾¼ã¾ã›ã€ãƒ™ã‚¯ãƒˆãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã€‚è³ªå•ã«å›ç­”ã™ã‚‹éš›ã«ã¯é–¢é€£ã™ã‚‹æƒ…å ±ã‚’æ¤œç´¢ã—ã¦ç²¾åº¦ã®é«˜ã„å›ç­”ã‚’ç”Ÿæˆ
- **é–‹ç™ºç’°å¢ƒ**: REST API, OpenAPI, ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ—ãƒ¬ã‚¤ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰
- **è©•ä¾¡**: ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å›ç­”ã‚’ã‚¹ã‚³ã‚¢ä»˜ã‘ã—ã¦ãƒ†ã‚¹ãƒˆã™ã‚‹
- **ã‚ªãƒ–ã‚¶ãƒ¼ãƒãƒ“ãƒªãƒ†ã‚£**: ãƒ­ã‚°ãƒ»ãƒˆãƒ¬ãƒ¼ã‚¹æ©Ÿèƒ½ã«ã‚ˆã‚‹é€æ˜æ€§ã®ç¢ºä¿
- Next.js ã¨ã®çµ±åˆ

ã“ã®è¨˜äº‹ã§ã¯ Mastra ã‚’ä½¿ç”¨ã—ã¦ AI ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’æ§‹ç¯‰ã™ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã™ã‚‹

### å‰ææ¡ä»¶

Mastra ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã«ã¯ LLM ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ API ã‚­ãƒ¼ãŒå¿…è¦ã§ã™ã€‚ä¸»ãªé¸æŠè‚¢ã¨ã—ã¦:

- [OpenAI](https://www.openai.com/) - GPT-4 ã‚„ GPT-3.5 ãªã©ã®ãƒ¢ãƒ‡ãƒ«
- [Anthropic](https://console.anthropic.com/settings/keys) - Claude ã‚·ãƒªãƒ¼ã‚ºã®ãƒ¢ãƒ‡ãƒ«
- [Gemini](https://ai.google.dev/gemini-api/docs) - Google ã® Gemini ãƒ¢ãƒ‡ãƒ«

ã‚ã‚‹ã„ã¯ã€[Ollama](https://ollama.com/) ã‚’ä½¿ç”¨ã—ã¦ãƒ­ãƒ¼ã‚«ãƒ« LLM ã§ Mastra ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚

ã“ã®è¨˜äº‹ã§ã¯ Anthropic ãŒæä¾›ã™ã‚‹ Claude ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚ã¾ãšã¯ [Anthropic ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«](https://console.anthropic.com/settings/keys) ã‹ã‚‰ API ã‚­ãƒ¼ã‚’ä½œæˆã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚

### ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ

API ã‚­ãƒ¼ã®æº–å‚™ãŒã§ããŸã‚‰ã€Mastra ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã™:

```bash
npx create-mastra@latest
```

ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒè¡¨ç¤ºã•ã‚Œã‚‹ã®ã§ã€é©å®œé¸æŠã—ã¦ã„ãã¾ã™:

```bash
What do you want to name your project? my-mastra-app
â—‡  Where should we create the Mastra files? (default: src/)
  src/
Choose components to install:
  â— Agents (recommended)
  â—¯ Tools
  â—¯ Workflows
â—‡  Add tools?
  â— Yes
  â—¯ No
Select default provider:
  â—¯ OpenAI (recommended)
  â— Anthropic
  â—¯ Groq
â—‡  Add example
  â— Yes
  â—¯ No
```

ã“ã®ä¾‹ã§ã¯ Agents ã¨ Tools ã‚’è¿½åŠ ã—ã€Anthropic ã‚’ãƒ—ãƒ­ãƒã‚¤ãƒ€ã¨ã—ã¦é¸æŠã—ã€ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’å«ã‚ã‚‹ã‚ˆã†æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚

ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§ API ã‚­ãƒ¼ã®å…¥åŠ›ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ãŸå ´åˆã¯ã€å¾Œã‹ã‚‰ `.env` ãƒ•ã‚¡ã‚¤ãƒ«ã«è¿½è¨˜ã—ã¦ãã ã•ã„ã€‚

```bash:.env
ANTHROPIC_API_KEY=YOUR_API_KEY
```

## Mastra ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚

```bash
my-mastra-app/
â”œâ”€â”€ .env.development
â”œâ”€â”€ .gitignore
â”œâ”€â”€ package-lock.json
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â””â”€â”€ src/
    |â”€â”€ mastra/
    |   â”œâ”€â”€ agents/
    |   |   â””â”€â”€ index.ts
    |   â”œâ”€â”€ tools/
    |   |   â””â”€â”€ index.ts
    |   â””â”€â”€ index.ts
```

`src/mastra` ãŒãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚³ã‚¢ã¨ãªã‚‹éƒ¨åˆ†ã§ã™ã€‚å„ãƒ•ã‚¡ã‚¤ãƒ«ã®å½¹å‰²ã‚’è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

### ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ

`src/mastra/index.ts` ãŒ Mastra ã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã§ã™ã€‚ã“ã“ã§ã¯ `Mastra` ã‚¯ãƒ©ã‚¹ã®åˆæœŸåŒ–ã¨ `weatherAgent` ã®ç™»éŒ²ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚

```ts:src/mastra/index.ts
import { Mastra } from '@mastra/core/mastra';
import { createLogger } from '@mastra/core/logger';

import { weatherAgent } from './agents';

export const mastra = new Mastra({
  agents: { weatherAgent },
  logger: createLogger({
    name: 'Mastra',
    level: 'info',
  }),
});
```

### ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å®šç¾©ã™ã‚‹

`src/mastra/agents/index.ts` ã§ã¯ `Agent` ã‚¯ãƒ©ã‚¹ã‚’ä½¿ç”¨ã—ã¦å¤©æ°—æƒ…å ±ã‚’æä¾›ã™ã‚‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å®šç¾©ã—ã¦ã„ã¾ã™ã€‚

```ts:src/mastra/agents/index.ts
import { anthropic } from '@ai-sdk/anthropic';
import { Agent } from '@mastra/core/agent';
import { weatherTool } from '../tools';

export const weatherAgent = new Agent({
  name: 'Weather Agent',
  instructions: `
      You are a helpful weather assistant that provides accurate weather information.

      Your primary function is to help users get weather details for specific locations. When responding:
      - Always ask for a location if none is provided
      - If giving a location with multiple parts (e.g. "New York, NY"), use the most relevant part (e.g. "New York")
      - Include relevant details like humidity, wind conditions, and precipitation
      - Keep responses concise but informative

      Use the weatherTool to fetch current weather data.
`,
  model: anthropic('claude-3-5-sonnet-20241022'),
  tools: { weatherTool },
});
```

`weatherAgent` ã¯ `Agent` ã‚¯ãƒ©ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§ã™ã€‚`instructions` ã«ã¯ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«å¯¾ã™ã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒè¨˜è¿°ã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã®ä¾‹ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§ã¯ç‰¹å®šã®å ´æ‰€ã®å¤©æ°—æƒ…å ±ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æä¾›ã™ã‚‹ã‚ˆã†ã«ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«æŒ‡ç¤ºã—ã¦ã„ã¾ã™ã€‚

`model` ã«ã¯ LLM ã®ãƒ¢ãƒ‡ãƒ«ã‚’æŒ‡å®šã—ã¾ã™ã€‚ãƒ¢ãƒ‡ãƒ«ã‚’æ¸¡ã™éš›ã«ã¯ [Vercel ã® AI SDK](https://sdk.vercel.ai/docs/foundations/providers-and-models) ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚ã“ã®ä¾‹ã§ã¯ Anthropic ã® `claude-3-5-sonnet-20241022` ã‚’æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚

`tools` ã«ã¯ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒä½¿ç”¨ã™ã‚‹ãƒ„ãƒ¼ãƒ«ã‚’æŒ‡å®šã—ã¾ã™ã€‚ãƒ„ãƒ¼ãƒ«ã¨ã¯ AI ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã™ã‚‹å¤–éƒ¨æ©Ÿèƒ½ã‚„ã‚·ã‚¹ãƒ†ãƒ ã®ã“ã¨ã§ã™ã€‚åŸºæœ¬çš„ã« AI ã¯ã‚ã‚‰ã‹ã˜ã‚å­¦ç¿’ã•ã‚ŒãŸã“ã¨ä»¥ä¸Šã®çŸ¥è­˜ã¯æŒã£ã¦ã„ãªã„ãŸã‚ã€æœ€æ–°ã®æƒ…å ±ï¼ˆç¾åœ¨ã®å¤©æ°—æƒ…å ±ãªã©ï¼‰ã‚’å›ç­”ã—ã‚ˆã†ã¨ã™ã‚‹ã¨èª¤ã£ãŸæƒ…å ±ã‚’è¿”ã™å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ãã“ã§ AI ã«å¯¾ã—ã¦ API ã‚„ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãªã©å¤–éƒ¨ã®æƒ…å ±ã‚’ä¸ãˆãã®æƒ…å ±ã‚’å…ƒã«å›ç­”ã‚’ç”Ÿæˆã•ã›ã‚‹ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã§ã€AI ã®å›ç­”ã®ç²¾åº¦ã‚’å‘ä¸Šã•ã›ã‚‹ã“ã¨ãŒæœŸå¾…ã§ãã¾ã™ã€‚

ãƒ„ãƒ¼ãƒ«ã¯ AI ãŒã©ã®ã‚ˆã†ãªæ–¹æ³•ã§å¤–éƒ¨æƒ…å ±ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‹ã‚’å®šç¾©ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Š AI ãŒå›ç­”ã‚’è¡Œã†ãŸã‚ã«å¤–éƒ¨æƒ…å ±ãŒå¿…è¦ã§ã‚ã‚‹ã¨åˆ¤æ–­ã—ãŸå ´åˆã«ã€AI å´ã‹ã‚‰ãƒ„ãƒ¼ãƒ«ã®å‘¼ã³å‡ºã—ã‚’è¦æ±‚ã—ã¾ã™ã€‚ãƒ„ãƒ¼ãƒ«ã®å‘¼ã³å‡ºã—ã‚’è¦æ±‚ã•ã‚ŒãŸãƒ—ãƒ­ã‚°ãƒ©ãƒ å´ã§ã¯ã€AI ãŒãƒ„ãƒ¼ãƒ«ã®å‘¼ã³å‡ºã—ã«ä½¿ç”¨ã—ãŸå¼•æ•°ã‚’å…ƒã«å¤–éƒ¨æƒ…å ±ã‚’å–å¾—ã—ã€ãã®æƒ…å ±ã‚’ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«è¿½åŠ ã—ã¦å†åº¦ AI ã«å›ç­”ã‚’æ±‚ã‚ã¾ã™ã€‚

### ãƒ„ãƒ¼ãƒ«ã‚’ä½œæˆã™ã‚‹

ã“ã“ã§ã¯ `weatherTool` ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚`weatherTool` ã¯å¤©æ°—æƒ…å ±ã‚’å¤–éƒ¨ã® API ã‹ã‚‰å¤©æ°—æƒ…å ±ã‚’å–å¾—ã™ã‚‹ãŸã‚ã®ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚`src/mastra/tools/index.ts` ã« `weatherTool` ã®å®Ÿè£…ãŒè¨˜è¿°ã•ã‚Œã¦ã„ã¾ã™ã€‚

```ts:src/mastra/tools/index.ts
import { createTool } from '@mastra/core/tools';
import { z } from 'zod';

interface GeocodingResponse {
  results: {
    latitude: number;
    longitude: number;
    name: string;
  }[];
}
interface WeatherResponse {
  current: {
    time: string;
    temperature_2m: number;
    apparent_temperature: number;
    relative_humidity_2m: number;
    wind_speed_10m: number;
    wind_gusts_10m: number;
    weather_code: number;
  };
}

export const weatherTool = createTool({
  id: 'get-weather',
  description: 'Get current weather for a location',
  inputSchema: z.object({
    location: z.string().describe('City name'),
  }),
  outputSchema: z.object({
    temperature: z.number(),
    feelsLike: z.number(),
    humidity: z.number(),
    windSpeed: z.number(),
    windGust: z.number(),
    conditions: z.string(),
    location: z.string(),
  }),
  execute: async ({ context }) => {
    return await getWeather(context.location);
  },
});

const getWeather = async (location: string) => {
  const geocodingUrl = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(location)}&count=1`;
  const geocodingResponse = await fetch(geocodingUrl);
  const geocodingData = (await geocodingResponse.json()) as GeocodingResponse;

  if (!geocodingData.results?.[0]) {
    throw new Error(`Location '${location}' not found`);
  }

  const { latitude, longitude, name } = geocodingData.results[0];

  const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m,apparent_temperature,relative_humidity_2m,wind_speed_10m,wind_gusts_10m,weather_code`;

  const response = await fetch(weatherUrl);
  const data = (await response.json()) as WeatherResponse;

  return {
    temperature: data.current.temperature_2m,
    feelsLike: data.current.apparent_temperature,
    humidity: data.current.relative_humidity_2m,
    windSpeed: data.current.wind_speed_10m,
    windGust: data.current.wind_gusts_10m,
    conditions: getWeatherCondition(data.current.weather_code),
    location: name,
  };
};

function getWeatherCondition(code: number): string {
  const conditions: Record<number, string> = {
    0: 'Clear sky',
    1: 'Mainly clear',
    2: 'Partly cloudy',
    3: 'Overcast',
    45: 'Foggy',
    48: 'Depositing rime fog',
    51: 'Light drizzle',
    53: 'Moderate drizzle',
    55: 'Dense drizzle',
    56: 'Light freezing drizzle',
    57: 'Dense freezing drizzle',
    61: 'Slight rain',
    63: 'Moderate rain',
    65: 'Heavy rain',
    66: 'Light freezing rain',
    67: 'Heavy freezing rain',
    71: 'Slight snow fall',
    73: 'Moderate snow fall',
    75: 'Heavy snow fall',
    77: 'Snow grains',
    80: 'Slight rain showers',
    81: 'Moderate rain showers',
    82: 'Violent rain showers',
    85: 'Slight snow showers',
    86: 'Heavy snow showers',
    95: 'Thunderstorm',
    96: 'Thunderstorm with slight hail',
    99: 'Thunderstorm with heavy hail',
  };
  return conditions[code] || 'Unknown';
}
```

å®Ÿè£…ã¯å°‘ã€…é•·ããªã£ã¦ã„ã¾ã™ãŒã€é †ç•ªã«è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚ãƒ„ãƒ¼ãƒ«ã‚’ä½œæˆã™ã‚‹ãŸã‚ã« `createTool` é–¢æ•°ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚ã“ã®é–¢æ•°ã¯ã€ãƒ„ãƒ¼ãƒ«ã®èª¬æ˜ã¨å…¥åŠ›ã‚¹ã‚­ãƒ¼ãƒ, å‡ºåŠ›ã‚¹ã‚­ãƒ¼ãƒ, ãƒ„ãƒ¼ãƒ«ã‚’å‘¼ã³å‡ºã—ãŸã¨ãã«å®Ÿè¡Œã•ã‚Œã‚‹é–¢æ•°ã‚’å—ã‘å–ã‚Šã¾ã™ã€‚

```ts:src/mastra/tools/index.ts
export const weatherTool = createTool({
  id: 'get-weather',
  description: 'Get current weather for a location',
  inputSchema: z.object({
    location: z.string(),
  }),
  outputSchema: z.object({
    temperature: z.number(),
    feelsLike: z.number(),
    humidity: z.number(),
    windSpeed: z.number(),
    windGust: z.number(),
    conditions: z.string(),
    location: z.string(),
  }),
  execute: async ({ context }) => {
    return await getWeather(context.location);
  },
});
```

ãƒ„ãƒ¼ãƒ«ã®èª¬æ˜ã¯ `description` ã«è¨˜è¿°ã—ã¾ã™ã€‚ãƒ„ãƒ¼ãƒ«ã®èª¬æ˜ã¯ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’å‘ä¸Šã•ã›ã‚‹ãŸã‚ã«é‡è¦ã§ã™ã€‚AI ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ãƒ„ãƒ¼ãƒ«ã®èª¬æ˜ã‚’èª­ã¿å–ã‚Šã€ãƒ„ãƒ¼ãƒ«ã‚’å‘¼ã³å‡ºã™ã¨ã©ã®ã‚ˆã†ãªæƒ…å ±ãŒè¿”ã£ã¦ãã‚‹ã‹ã€ãƒ„ãƒ¼ãƒ«ã¯ã„ã¤å‘¼ã³å‡ºã™ã¹ããªã®ã‹ã€å„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®æ„å‘³ã¨ãã‚ŒãŒãƒ„ãƒ¼ãƒ«ã®å®Ÿè¡Œã«ã©ã®ã‚ˆã†ãªå½±éŸ¿ã‚’ä¸ãˆã‚‹ã‹ã‚’ç†è§£ã—ã¾ã™ã€‚ãƒ„ãƒ¼ãƒ«ã«ã¤ã„ã¦ AI ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«æä¾›ã§ãã‚‹ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãŒå¤šã‘ã‚Œã°å¤šã„ã»ã©ã€ãƒ„ãƒ¼ãƒ«ã‚’ã„ã¤ã©ã®ã‚ˆã†ã«ä½¿ç”¨ã™ã‚‹ã‹é©åˆ‡ã«åˆ¤æ–­ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã‚ˆã†ã§ã™ã€‚[Anthropic ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.anthropic.com/en/docs/build-with-claude/tool-use/overview) ã«ã‚ˆã‚‹ã¨ã€ãƒ„ãƒ¼ãƒ«ã®èª¬æ˜ã«å°‘ãªãã¨ã‚‚ 3 ~ 4 åˆ†ã®æƒ…å ±ã‚’å«ã‚ã‚‹ã“ã¨ãŒæ¨å¥¨ã•ã‚Œã¦ã„ã¾ã™ã€‚

ãƒ„ãƒ¼ãƒ«ã®å…¥åŠ›ã‚¹ã‚­ãƒ¼ãƒã¨å‡ºåŠ›ã‚¹ã‚­ãƒ¼ãƒã¯ãã‚Œãã‚Œ `inputSchema` ã¨ `outputSchema` ã«è¨˜è¿°ã—ã¾ã™ã€‚ãƒ„ãƒ¼ãƒ«ã« JSON ã‚¹ã‚­ãƒ¼ãƒã‚’æä¾›ã™ã‚‹ã“ã¨ã«ã‚ˆã‚Šã€AI ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒæœŸå¾…ã™ã‚‹å½¢å¼ã§å›ç­”ã‚’è¡Œã†ã‚ˆã†ã«æŒ‡ç¤ºã§ãã¾ã™ã€‚ã“ã‚Œã¯æ§‹é€ åŒ–ã•ã‚ŒãŸå‡ºåŠ›ã¨å‘¼ã°ã‚Œã¦ã„ã¾ã™ã€‚æ§‹é€ åŒ–ã•ã‚ŒãŸå‡ºåŠ›ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‹ã‚‰ä¿¡é ¼æ€§ã®é«˜ã„æ–¹æ³•ã§ AI ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨ã‚„ã‚Šå–ã‚Šã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚JSON ã‚¹ã‚­ãƒ¼ãƒã¯ [Zod](https://github.com/colinhacks/zod) ã‚’ä½¿ç”¨ã—ã¦æ¸¡ã™ã“ã¨ãŒã§ãã¾ã™ã€‚

ã“ã®ä¾‹ã§ã¯çœç•¥ã•ã‚Œã¦ã„ã¾ã™ãŒã€ã‚¹ã‚­ãƒ¼ãƒã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã« `describe` ãƒ¡ã‚½ãƒƒãƒ‰ã§èª¬æ˜ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã§ã€AI ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒé©åˆ‡ã«ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã®æƒ…å ±ã‚’æä¾›ã§ãã¾ã™ã€‚

```ts:src/mastra/tools/index.ts
const weatherTool = createTool({
  inputSchema: z.object({
    location: z.string().describe('Name of the city which weather information is requested, e.g. "New York"'),
  }),
}),
```

`execute` ãƒ¡ã‚½ãƒƒãƒ‰ã«æ¸¡ã—ã¦ã„ã‚‹ `getWeather` é–¢æ•°ã¯ã€å¤–éƒ¨ã® API ã‹ã‚‰å¤©æ°—æƒ…å ±ã‚’å–å¾—ã™ã‚‹ãŸã‚ã®é–¢æ•°ã§ã™ã€‚`execute` ãƒ¡ã‚½ãƒƒãƒ‰ã®å¼•æ•°ã® `context` ã«ã¯ `inputSchema` ã§æŒ‡å®šã—ãŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒæ¸¡ã•ã‚Œã¾ã™ã€‚ã“ã®ä¾‹ã§ã¯ `location` ãŒæ¸¡ã•ã‚Œã‚‹ã“ã¨ãŒæœŸå¾…ã•ã‚Œã¦ã„ã¾ã™ã€‚æ§‹é€ åŒ–ã•ã‚ŒãŸå‡ºåŠ›ã«ã‚ˆã‚Šå‹å®‰å…¨ã«å¼•æ•°ã‚’å—ã‘å–ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```ts:src/mastra/tools/index.ts
export const weatherTool = createTool({
  execute: async ({ context }) => {
    return await getWeather(context.location);
  },
});
```

`getWeather` é–¢æ•°ã®å®Ÿè£…ã®è©³ç´°ã¯çœç•¥ã—ã¾ã™ãŒã€ã“ã®é–¢æ•°ã®è¿”ã‚Šå€¤ã¯ `outputSchema` ã§æŒ‡å®šã—ãŸå½¢å¼ã«å¾“ã£ã¦ã„ã‚‹ã“ã¨ãŒæœŸå¾…ã•ã‚Œã¾ã™ã€‚

```ts:src/mastra/tools/index.ts
const getWeather = async (location: string) => {
  const geocodingUrl = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(location)}&count=1`;
  const geocodingResponse = await fetch(geocodingUrl);

  // çœç•¥

  return {
    temperature: data.current.temperature_2m,
    feelsLike: data.current.apparent_temperature,
    humidity: data.current.relative_humidity_2m,
    windSpeed: data.current.wind_speed_10m,
    windGust: data.current.wind_gusts_10m,
    conditions: getWeatherCondition(data.current.weather_code),
    location: name,
  };
};
```

## Mastra ã‚µãƒ¼ãƒãƒ¼ã‚’å®Ÿè¡Œã™ã‚‹

Mastra ã¯ REST API ã‚µãƒ¼ãƒãƒ¼ã‚’ä»‹ã—ã¦ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨ã‚„ã‚Šå–ã‚Šã—ã¾ã™ã€‚ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ Mastra ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¾ã™ã€‚

```bash
npm run dev
```

æˆåŠŸã™ã‚‹ã¨ã€æ¬¡ã®ã‚ˆã†ãªã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

```sh
ğŸ¦„ Mastra API running on port 4111/api
ğŸ“š Open API documentation available at http://localhost:4111/openapi.json
ğŸ§ª Swagger UI available at http://localhost:4111/swagger-ui
ğŸ‘¨â€ğŸ’» Playground available at http://localhost:4111/
```

`curl` ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ API ã‚µãƒ¼ãƒãƒ¼ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯ `http://localhost:4111/api/agents/{agentId}/generate` ã§ã™ã€‚`agentId` ã¯ `new Mastra` ã® `agents` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã§æŒ‡å®šã—ãŸã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®åå‰ã§ã™ã€‚

```bash
curl -X POST http://localhost:4111/api/agents/weatherAgent/generate \
-H "Content-Type: application/json" \
-d '{"messages": ["ç®±æ ¹ã®å¤©æ°—ã¯ï¼Ÿ"]}'
```

å®Ÿéš›ã«å®Ÿè¡Œã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã£ã¦ãã¾ã—ãŸã€‚

```json
{
  "text":"ç®±æ ¹ã®ç¾åœ¨ã®å¤©æ°—ã‚’ãŠçŸ¥ã‚‰ã›ã—ã¾ã™ï¼š

  - æ°—æ¸©: 6.2Â°C
  - ä½“æ„Ÿæ¸©åº¦: 3.8Â°C
  - æ¹¿åº¦: 56%
  - é¢¨é€Ÿ: 5.7m/sï¼ˆçªé¢¨: 28.4m/sï¼‰
  - å¤©å€™: ãŠãŠã‚€ã­æ™´ã‚Œ

  ã‚„ã‚„è‚Œå¯’ã„æ°—æ¸©ã§ã€é¢¨ã‚‚ã‚ã‚Šã¾ã™ã®ã§ã€å¤–å‡ºã•ã‚Œã‚‹éš›ã¯é˜²å¯’å¯¾ç­–ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚",
  "reasoningDetails": [],
  "finishReason": "stop",
  "usage": {...}
}
```

### ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ—ãƒ¬ã‚¤ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’ä½¿ç”¨ã™ã‚‹

http://localhost:4111/ ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ Mastra ã®ãƒ—ãƒ¬ã‚¤ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ã“ã“ã‹ã‚‰ `weatherAgent` ã‚’é¸æŠã§ãã¾ã™ã€‚

![](https://images.ctfassets.net/in6v9lxmm5c8/63ZgwUo8TtUpBLDblIDNto/d563a5df23064179221929033f894614/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88_2025-03-09_12.14.07.png)

ãƒ—ãƒ¬ã‚¤ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ã¯ãƒãƒ£ãƒƒãƒˆå½¢å¼ã§ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨ã‚„ã‚Šå–ã‚ŠãŒã§ãã€ãƒ¢ãƒ‡ãƒ«æƒ…å ±ã‚„ãƒˆãƒ¬ãƒ¼ã‚¹æƒ…å ±ã‚‚ç¢ºèªã§ãã¾ã™ã€‚

![](https://images.ctfassets.net/in6v9lxmm5c8/0GeCdvgqzCPHsateprwl6/e7dd96cc965b0b2587b8ef82ac03de5d/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88_2025-03-09_12.17.09.png)

ã€ŒToolsã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é¸æŠã™ã‚‹ã¨ã€å„ãƒ„ãƒ¼ãƒ«ã‚’å€‹åˆ¥ã«ãƒ†ã‚¹ãƒˆã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

![](https://images.ctfassets.net/in6v9lxmm5c8/32CHbuTfQe8qta1v6GznV9/1a6eb9f3bfb4f71bfa10e211d64c5c50/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88_2025-03-09_12.22.48.png)

## AI ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®è©•ä¾¡

AI ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å“è³ªã‚’ç¢ºä¿ã™ã‚‹ãŸã‚ã«è¤‡æ•°ã®è¦–ç‚¹ã‹ã‚‰ã®è©•ä¾¡ãŒæ¬ ã‹ã›ã¾ã›ã‚“ã€‚Mastra ã§ã¯ 0ã€œ1 ã®æ­£è¦åŒ–ã•ã‚ŒãŸã‚¹ã‚³ã‚¢ã§è©•ä¾¡ã‚’è¡Œãˆã¾ã™ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã„ãã¤ã‹ã®è©•ä¾¡ãƒ¡ãƒˆãƒªãƒƒã‚¯ãŒæä¾›ã•ã‚Œã¦ã„ã¾ã™ãŒã€ã‚«ã‚¹ã‚¿ãƒ è©•ä¾¡ãƒ¡ãƒˆãƒªãƒƒã‚¯ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚

https://mastra.ai/docs/evals/01-supported-evals

ã“ã‚Œã‚‰ã®è©•ä¾¡ã¯ã‚¯ãƒ©ã‚¦ãƒ‰ä¸Šã§å®Ÿè¡Œã§ãã‚‹ã»ã‹ã€ãƒ†ã‚¹ãƒ†ã‚£ãƒ³ã‚°ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’ä½¿ç”¨ã—ã¦ CI/CD ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã«çµ„ã¿è¾¼ã‚€ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚

ã¾ãšã€å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```bash
npm i @mastra/evals 
```

ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå®šç¾©ã«è©•ä¾¡ãƒ¡ãƒˆãƒªãƒƒã‚¯ã‚’è¿½åŠ ã—ã¾ã™ã€‚`Agent` ã‚¯ãƒ©ã‚¹ã® `evals` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã« `{ è©•ä¾¡å: è©•ä¾¡ãƒ¡ãƒˆãƒªãƒƒã‚¯ }` ã®å½¢å¼ã§è¿½åŠ ã—ã¾ã™ã€‚ã“ã®ä¾‹ã§ã¯ `ToxicityMetric` ã‚’ä½¿ç”¨ã—ã¦æœ‰å®³ãªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒå«ã¾ã‚Œã¦ã„ãªã„ã‹ã‚’è©•ä¾¡ã—ã¦ã„ã¾ã™ã€‚`ToxicityMetric` ãƒ¡ãƒˆãƒªãƒƒã‚¯è‡ªèº«ã‚‚ LLM ã‚’ä½¿ç”¨ã—ã¦è©•ä¾¡ã‚’è¡Œã£ã¦ã„ã‚‹ãŸã‚ã€ãƒ¢ãƒ‡ãƒ«ã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```ts:src/mastra/agents/index.ts {4, 14-16}
import { anthropic } from "@ai-sdk/anthropic";
import { Agent } from "@mastra/core/agent";
import { weatherTool } from "../tools";
import { ToxicityMetric } from "@mastra/evals/llm";

export const weatherAgent = new Agent({
  name: "Weather Agent",
  instructions: `
      You are a helpful weather assistant that provides accurate weather information.
      // ...existing code...
`,
  model: anthropic("claude-3-5-sonnet-20241022"),
  tools: { weatherTool },
  evals: {
    toxicity: new ToxicityMetric(anthropic("claude-3-5-sonnet-20241022")),
  },
});
```

ãƒ—ãƒ¬ã‚¤ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã®ã€ŒEvalsã€ã‚¿ãƒ–ã§è©•ä¾¡çµæœã‚’ç¢ºèªã§ãã¾ã™ã€‚ã„ãšã‚Œã®è©•ä¾¡çµæœã‚‚ã‚¹ã‚³ã‚¢ãŒ 0.00 ã§ã‚ã‚Šã€æœ‰å®³ãªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒå«ã¾ã‚Œã¦ã„ãªã„ã“ã¨ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚

![](https://images.ctfassets.net/in6v9lxmm5c8/O0Sw2jr2SMCyyPyKrUVYI/8f6add56bd8d7a5c8082dd091d7e5eb7/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88_2025-03-09_13.08.48.png)

### Vitest ã‚’ä½¿ç”¨ã—ã¦ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹

[Vitest](https://vitest.dev) ãªã©ã®ãƒ†ã‚¹ãƒ†ã‚£ãƒ³ã‚°ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’ä½¿ç”¨ã—ã¦ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒ†ã‚¹ãƒˆã‚’è‡ªå‹•åŒ–ã§ãã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Š CI/CD ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã«çµ„ã¿è¾¼ã‚€ã“ã¨ãŒã§ãã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å“è³ªã‚’ç¶­æŒã§ãã¾ã™ã€‚

ã¾ãšã€Vitest ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```bash
npm i vitest -D
```

ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’è©•ä¾¡ã—ã¦ãƒ†ã‚¹ãƒˆã™ã‚‹ãŸã‚ã®ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚ã“ã“ã§ã¯ã€è©•ä¾¡ã®çµæœãŒ 0 ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚

```ts:tests/agents/weatherAgent.test.ts
import { describe, it, expect } from "vitest";
import { evaluate } from "@mastra/evals";
import { weatherAgent } from "./index";
import { ToxicityMetric } from "@mastra/evals/llm";
import { anthropic } from "@ai-sdk/anthropic";

describe("Weather Agent", () => {
  // LLMå¿œç­”ã‚’å¾…ã¤ãŸã‚ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’é•·ã‚ã«è¨­å®š
  it("æœ‰å®³ãªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒå«ã¾ã‚Œã¦ã„ãªã„ã‹", { timeout: 50000 }, async () => {
    const metric = new ToxicityMetric(anthropic("claude-3-5-sonnet-20241022"));
    const result = await evaluate(weatherAgent, "å¾³å³¶ã®å¤©æ°—ã¯ï¼Ÿ", metric);

    expect(result.score).toBe(0);
  });
});
```

ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’è¿½åŠ ã—ã¾ã™ã€‚

```json:package.json
{
  "scripts": {
    "test": "vitest"
  }
}
```

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

```bash
npm test
```

ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªçµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

```bash

 âœ“ src/mastra/agents/weatherAgent.test.ts (1 test) 15449ms
   âœ“ Weather Agent > æœ‰å®³ãªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒå«ã¾ã‚Œã¦ã„ãªã„ã‹ 15447ms

 Test Files  1 passed (1)
      Tests  1 passed (1)
   Start at  13:31:24
   Duration  15.96s

 PASS  Waiting for file changes...
       press h to show help, press q to quit
Cancelling test run. Press CTRL+c again to exit forcefully.
```

ã“ã®ã¾ã¾ã§ã‚‚ãƒ†ã‚¹ãƒˆã¯å•é¡Œãªãå®Ÿè¡Œã§ãã¾ã™ãŒã€è¿½åŠ ã®è¨­å®šã‚’è¡Œã†ã“ã¨ã§ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ãƒ†ã‚¹ãƒˆçµæœã‚’ç¢ºèªã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚`globalSetup` ã¨ `setupFiles` ã‚’ä½¿ç”¨ã—ã¦ã€ãƒ†ã‚¹ãƒˆã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’è¡Œã„ã¾ã™ã€‚

```ts:globalSetup.ts
import { globalSetup } from '@mastra/evals';

export default function setup() {
  globalSetup()
}
```

```ts:testSetup.ts
import { beforeAll } from 'vitest';
import { attachListeners } from '@mastra/evals';

beforeAll(async () => {
  await attachListeners();
});
```

Vitest ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ« `vitest.config.ts` ã« `globalSetup` ã¨ `setupFiles` ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```ts:vitest.config.ts
import { defineConfig } from 'vitest/config'
export default defineConfig({
  test: {
    globalSetup: './globalSetup.ts',
    setupFiles: ['./testSetup.ts'],
  },
})
```

è¨­å®šã‚’è¿½åŠ ã—ãŸå¾Œã«å†åº¦ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

## ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’ OpenTelemetry ã§åé›†ã™ã‚‹

AI ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’é‹ç”¨ã™ã‚‹éš›ã«ã¯ã‚ªãƒ–ã‚¶ãƒ¼ãƒãƒ“ãƒªãƒ†ã‚£ã‚’ç¢ºä¿ã™ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚ãƒ­ã‚°ã‚„ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’åé›†ã—ã¦åˆ†æã™ã‚‹ã“ã¨ã§ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å‹•ä½œã‚’ã‚ˆã‚Šæ·±ãç†è§£ã—ã€æ”¹å–„ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

ç‰¹ã«ãƒˆãƒ¬ãƒ¼ã‚¹æ©Ÿèƒ½ã¯ã€AI ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’æ§‹ç¯‰ã™ã‚‹ã†ãˆã§æ¬ ã‹ã›ãªã„è¦ç´ ã§ã™ã€‚è¤‡é›‘ãªã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œã™ã‚‹ AI ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã€è¤‡æ•°ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’çµŒã¦å›ç­”ã‚’ç”Ÿæˆã—ã¾ã™ã€‚ãƒˆãƒ¬ãƒ¼ã‚¹ãŒç„¡ã„ã¨å„ã‚¹ãƒ†ãƒƒãƒ—ã§ã©ã®ã‚ˆã†ãªå›ç­”ãŒç”Ÿæˆã•ã‚ŒãŸã®ã‹ã‚’æŠŠæ¡ã™ã‚‹ã“ã¨ãŒé›£ã—ããªã‚Šã¾ã™ã€‚å„ã‚¹ãƒ†ãƒƒãƒ—ã®å…¥åŠ›ã¨å‡ºåŠ›ã‚’å¯è¦–åŒ–ã™ã‚‹ã“ã¨ãŒ AI ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ç²¾åº¦ã‚’å‘ä¸Šã•ã›ã‚‹ãŸã‚ã«ä¸å¯æ¬ ã§ã™ã€‚

Mastra ã§ã¯ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒˆãƒ¬ãƒ¼ã‚¹ã¨ç›£è¦–ã®ãŸã‚ã« [OpenTelemetry](https://opentelemetry.io/) ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ã€‚OpenTelemetry ã¯åˆ†æ•£ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°ã®ãŸã‚ã®ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ã®è¦æ ¼ã§ã™ã€‚OpenTelemetry ã®è¦æ ¼ã«å¾“ã†ã“ã¨ã§ã€ãƒˆãƒ¬ãƒ¼ã‚¹ãƒ»ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãƒ»ãƒ­ã‚°ãªã©ã®ãƒ†ãƒ¬ãƒ¡ãƒˆãƒªãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ™ãƒ³ãƒ€ãƒ¼ã‚„ãƒ„ãƒ¼ãƒ«ã«ã¨ã‚‰ã‚ã‚Œãšã«åé›†ãƒ»ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’æœ‰åŠ¹ã«ã™ã‚‹ãŸã‚ã«ã¯ `Mastra` ã‚¯ãƒ©ã‚¹ã®åˆæœŸåŒ–æ™‚ã« `telemetry` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’æŒ‡å®šã—ã¾ã™ã€‚

```ts:src/mastra/index.ts
import { Mastra } from '@mastra/core/mastra';

export const mastra = new Mastra({
  // ...
  telemetry: {
    serviceName: "my-mastra-app",
    enabled: true,
    sampling: {
      type: "always_on",
    },
    export: {
      type: "otlp",
      endpoint: "http://localhost:4318/v1/traces", // å¾Œã‹ã‚‰ä½œæˆã™ã‚‹ OpenTelemetry Collector ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
    },
  },
});
```

`export` ã® URL ã§ã¯ [OpenTelemetry Collector](https://opentelemetry.io/docs/collector/) ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’æŒ‡å®šã—ã¾ã™ã€‚OpenTelemetry Collector ã¯è¤‡æ•°ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‹ã‚‰åé›†ã—ãŸãƒˆãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’é›†ç´„ã—ã€ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãŸã‚ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã™ã€‚

ã“ã“ã§ã¯ Docker ã§ [local LGTM ã‚¹ã‚¿ãƒƒã‚¯](https://github.com/grafana/docker-otel-lgtm/tree/main?tab=readme-ov-file)ï¼ˆPrometheus, Grafana, Loki, Tempoï¼‰ã‚’ä½¿ç”¨ã—ã¦ OpenTelemetry Collector ã¨ç›£è¦–ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã‚’ç«‹ã¡ä¸Šã’ã¾ã™ã€‚

```bash
docker run --name lgtm -p 3000:3000 -p 4317:4317 -p 4318:4318 --rm -ti \
	-v "$PWD"/lgtm/grafana:/data/grafana \
	-v "$PWD"/lgtm/prometheus:/data/prometheus \
	-v "$PWD"/lgtm/loki:/data/loki \
	-e GF_PATHS_DATA=/data/grafana \
	docker.io/grafana/otel-lgtm:0.8.1
``` 

http://localhost:3000 ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ Grafana ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚Explore ç”»é¢ã§ Tempo ã«ä¿å­˜ã•ã‚ŒãŸãƒˆãƒ¬ãƒ¼ã‚¹ã‚’ç¢ºèªã§ãã¾ã™ã€‚

![](https://images.ctfassets.net/in6v9lxmm5c8/19Hrn3KaMZOsLDl05tdMNe/951d2d00656c20f731d9862c49d5a793/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88_2025-03-09_14.11.24.png)

ä»Šå›ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã§èµ·å‹•ã—ãŸ Grafana ã«ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’æŠ•ç¨¿ã—ã¾ã—ãŸãŒã€Mastra ã§ã¯ SigNoz, Langsmith, New Relic ãªã©ã®ã‚ªãƒ–ã‚¶ãƒ¼ãƒãƒ“ãƒªãƒ†ã‚£ãƒ—ãƒ­ãƒã‚¤ãƒ€ã¨ã®é€£æºæ–¹æ³•ãŒç´¹ä»‹ã•ã‚Œã¦ã„ã¾ã™ã€‚

https://mastra.ai/docs/reference/observability/providers

## ã¾ã¨ã‚

- Mastra ã¯ TypeScript ã§è¨˜è¿°ã•ã‚ŒãŸ AI ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’æ§‹ç¯‰ã™ã‚‹ãŸã‚ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯
- Mastra å®Ÿè¡Œã™ã‚‹ã¨ REST API ã‚µãƒ¼ãƒãƒ¼ã€Swagger UIã€Playground ãŒèµ·å‹•ã™ã‚‹
- Mastra ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã«ã¯ OpenAI, Anthropic, Gimini ãªã©ã® LLM ãƒ—ãƒ­ãƒã‚¤ãƒ€ã® API ã‚­ãƒ¼ã‚’å–å¾—ã™ã‚‹ã€‚ãƒ­ãƒ¼ã‚«ãƒ« LLN ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½
- AI ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®æ§‹ç¯‰ã€è©•ä¾¡ã€ãƒˆãƒ¬ãƒ¼ã‚¹ã®åé›†ãŒç°¡å˜ã«è¡Œãˆã‚‹

## å‚è€ƒ

- [The Typescript AI framework - Mastra](https://mastra.ai/)
- [Tool use with Claude - Anthropic](https://docs.anthropic.com/en/docs/build-with-claude/tool-use/overview)
